<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Owner Dashboard - HotelGroup</title>
</head>
<body>

<div layout:fragment="content" class="bg-light py-5">
    <div class="container" style="max-width: 1200px;">

        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="font-serif fw-bold h2 m-0 text-dark">Executive Dashboard</h1>
                <p class="text-secondary small mb-0">Network Overview & Financials</p>
            </div>
            <span class="badge bg-dark text-white border border-light-subtle fw-normal rounded-1 px-3 py-2 text-uppercase" style="letter-spacing: 0.1em;">
                Owner Access
            </span>
        </div>

        <div class="row g-4">

            <div class="col-md-3">
                <div class="bg-white p-3 shadow-sm border border-light-subtle rounded-1 h-100">
                    <div class="d-flex flex-column gap-2 sticky-top" style="top: 100px;">

                        <div class="text-secondary x-small fw-bold text-uppercase mb-2 ps-2">Financials</div>

                        <button onclick="showSection('pl')" class="btn btn-luxury w-100 text-start d-flex justify-content-between align-items-center mb-2">
                            <span>Profit & Loss</span>
                            <span>&rsaquo;</span>
                        </button>

                        <button class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2" disabled>
                            Service Popularity
                        </button>

                        <button onclick="showSection('services')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Service Popularity
                        </button>

                        <button onclick="showSection('empStats')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Employees Stats
                        </button>

                        <button onclick="showSection('schedule')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Daily Schedule
                        </button>

                        <button onclick="showSection('promos')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Marketing & Promos
                        </button>

                        <button onclick="showSection('roi')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Marketing ROI
                        </button>

                        <div class="text-secondary x-small fw-bold text-uppercase mt-3 mb-2 ps-2">Network</div>

                        <button onclick="showSection('payroll')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Payroll
                        </button>

                        <button onclick="showSection('occupancy')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Occupancy Rates
                        </button>

                        <button onclick="showSection('cancellations')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Cancellation Analysis
                        </button>

                        <button onclick="showSection('sentiment')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Sentiment Analysis
                        </button>

                        <button onclick="logoutUser()" class="btn btn-outline-danger w-100 text-start border-0 mt-2">
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="bg-white p-5 shadow-sm border-top border-4 border-dark rounded-1" style="min-height: 600px;">

                    <div id="plSection">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Profit & Loss Analysis</h3>
                        <p class="text-secondary small mb-4">Analyze financial performance and cash flow (Income, Expenses, Running Balance).</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <input type="number" id="plHotelId" class="form-control rounded-1 p-2" placeholder="e.g. 1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="plStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="plEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadFinancials()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Generate Report
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="plSummary" style="display: none;">
                            <div class="row g-4 text-center mb-5">
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Total Income</div>
                                        <div class="fs-3 fw-bold text-success" id="valIncome">0 ₴</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Total Expenses</div>
                                        <div class="fs-3 fw-bold text-danger" id="valExpenses">0 ₴</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-4 border border-dark rounded-1 bg-dark text-white h-100">
                                        <div class="text-white-50 x-small text-uppercase fw-bold mb-2">Net Profit</div>
                                        <div class="fs-3 fw-bold" id="valProfit">0 ₴</div>
                                    </div>
                                </div>
                            </div>

                            <h5 class="font-serif fw-bold mb-3">Detailed Ledger (Running Balance)</h5>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border" id="ledgerTable">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Date</th>
                                        <th class="py-3">Category</th>
                                        <th class="py-3">Description</th>
                                        <th class="text-end py-3">Income</th>
                                        <th class="text-end py-3">Expense</th>
                                        <th class="text-end pe-3 py-3 fw-bold">Balance</th>
                                    </tr>
                                    </thead>
                                    <tbody id="ledgerBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="plLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                        <div id="commonError" class="alert alert-danger mt-3 small" style="display: none;"></div>

                    </div>
                    <div id="servicesSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Service Popularity</h3>
                        <p class="text-secondary small mb-4">Identify top-performing hotel services and revenue sources.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <input type="number" id="srvHotelId" class="form-control rounded-1 p-2" placeholder="e.g. 1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="srvStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="srvEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadServicesReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Analyze
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="servicesSummary" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Rank</th>
                                        <th class="py-3">Service Name</th>
                                        <th class="text-center py-3">Usage Count</th>
                                        <th class="text-end pe-3 py-3">Total Revenue</th>
                                    </tr>
                                    </thead>
                                    <tbody id="servicesBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="srvLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                    <div id="empStatsSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Employee Performance</h3>
                        <p class="text-secondary small mb-4">Detailed individual statistics and KPI metrics.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <div class="input-group">
                                    <input type="number" id="empHotelId" class="form-control rounded-start-1 p-2" placeholder="ID" value="1">
                                    <button onclick="loadOwnerStaffList()" class="btn btn-outline-secondary" type="button">Load</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Select Employee</label>
                                <select id="empSelect" class="form-select rounded-1 p-2">
                                    <option value="" disabled selected>Enter Hotel ID & Load List first...</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadEmployeeStats()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Get Stats
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="empStatsResult" style="display: none;">

                            <div class="d-flex align-items-center mb-4">
                                <div class="bg-dark text-white rounded-circle d-flex align-items-center justify-content-center font-serif fw-bold fs-4 me-3" style="width: 60px; height: 60px;" id="esInitials">
                                    A
                                </div>
                                <div>
                                    <h4 class="font-serif fw-bold text-dark mb-0" id="esName">Employee Name</h4>
                                    <span class="badge bg-light text-secondary border fw-normal text-uppercase x-small" id="esPosition">Position</span>
                                </div>
                            </div>

                            <div class="row g-4 mb-4">
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-white h-100 text-center">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Total Shifts</div>
                                        <div class="fs-2 fw-bold text-dark" id="esShifts">0</div>
                                        <div class="text-muted x-small">Completed work shifts</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-white h-100 text-center">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Avg Rating</div>
                                        <div class="fs-2 fw-bold text-warning" id="esRating">0.0</div>
                                        <div class="text-muted x-small">Based on guest reviews</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-white h-100 text-center">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Negative Feedback</div>
                                        <div class="fs-2 fw-bold" id="esComplaints">0</div>
                                        <div class="text-muted x-small">Reviews < 3 stars</div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4 bg-light rounded-1 border border-light-subtle">
                                <h6 class="font-serif fw-bold text-dark mb-2">Latest Guest Feedback</h6>
                                <p class="fst-italic text-secondary mb-0" id="esComment">"No reviews available yet."</p>
                            </div>
                        </div>

                        <div id="empLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                    <div id="scheduleSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Staff Schedule</h3>
                        <p class="text-secondary small mb-4">View operational shifts across the network.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <input type="number" id="schHotelId" class="form-control rounded-1 p-2" placeholder="e.g. 1" value="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Date</label>
                                <input type="date" id="schDate" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadOwnerSchedule()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Load Schedule
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="scheduleResult" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Employee</th>
                                        <th class="py-3">Position</th>
                                        <th class="text-center py-3">Start Time</th>
                                        <th class="text-center py-3">End Time</th>
                                        <th class="text-end pe-3 py-3">Duration</th>
                                    </tr>
                                    </thead>
                                    <tbody id="scheduleBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="schLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                    <div id="payrollSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Payroll Overview</h3>
                        <p class="text-secondary small mb-4">Current salary configurations and estimated net payouts.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-4">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <input type="number" id="payHotelId" class="form-control rounded-1 p-2" placeholder="e.g. 1" value="1">
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadPayrollReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Load Sheet
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="payrollResult" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Employee</th>
                                        <th class="py-3">Position</th>
                                        <th class="text-end py-3">Base Salary</th>
                                        <th class="text-end pe-3 py-3 fw-bold text-success">Net Payout</th>
                                    </tr>
                                    </thead>
                                    <tbody id="payrollBody">
                                    </tbody>
                                    <tfoot class="table-light border-top">
                                    <tr>
                                        <td colspan="3" class="text-end fw-bold py-3 small text-uppercase">Total Estimated Payout:</td>
                                        <td class="text-end pe-3 fw-bold fs-5 text-dark" id="payrollTotal">0 ₴</td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="mt-3 text-muted x-small fst-italic">
                                * Net Payout is calculated as: Base Salary + Bonuses - Penalties - Tax.
                            </div>
                        </div>

                        <div id="payLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                    <div id="occupancySection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Occupancy by Category</h3>
                        <p class="text-secondary small mb-4">Analyze room usage efficiency based on comfort levels.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <input type="number" id="occHotelId" class="form-control rounded-1 p-2" placeholder="e.g. 1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="occStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="occEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadOccupancyReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Analyze
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="occupancyResult" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Category</th>
                                        <th class="text-center py-3">Total Capacity (Days)</th>
                                        <th class="text-center py-3">Occupied (Days)</th>
                                        <th class="pe-3 py-3" style="width: 40%;">Occupancy Rate</th>
                                    </tr>
                                    </thead>
                                    <tbody id="occupancyBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="occLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                    <div id="cancellationsSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Cancellation Reasons</h3>
                        <p class="text-secondary small mb-4">Understand why guests are cancelling their bookings.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <input type="number" id="cancHotelId" class="form-control rounded-1 p-2" placeholder="e.g. 1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="cancStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="cancEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadCancellationsReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Analyze
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="cancellationsResult" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3" style="width: 40%;">Reason</th>
                                        <th class="text-center py-3">Count</th>
                                        <th class="pe-3 py-3">Percentage of Total Cancellations</th>
                                    </tr>
                                    </thead>
                                    <tbody id="cancellationsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="cancLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                    <div id="sentimentSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Guest Sentiment Analysis</h3>
                        <p class="text-secondary small mb-4">Review guest feedback and automated sentiment classification.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-4">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <input type="number" id="sentHotelId" class="form-control rounded-1 p-2" placeholder="e.g. 1" value="1">
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadSentimentReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Analyze Reviews
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="sentimentResult" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Date</th>
                                        <th class="py-3">Employee Context</th>
                                        <th class="text-center py-3">Rating</th>
                                        <th class="text-center py-3">Sentiment</th>
                                        <th class="pe-3 py-3" style="width: 40%;">Comment</th>
                                    </tr>
                                    </thead>
                                    <tbody id="sentimentBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="sentLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                    <div id="promosSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Marketing Campaigns</h3>
                        <p class="text-secondary small mb-4">Manage discount codes and promotional offers.</p>

                        <div class="bg-light p-4 rounded-1 border border-light-subtle mb-5">
                            <h5 class="font-serif fw-bold h6 mb-3">Create New Promotion</h5>
                            <form id="createPromoForm">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-3">
                                        <label class="form-label x-small fw-bold text-uppercase text-secondary">Code</label>
                                        <input type="text" name="code" class="form-control rounded-1 p-2" placeholder="SUMMER2025" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label x-small fw-bold text-uppercase text-secondary">Discount %</label>
                                        <input type="number" name="discount" class="form-control rounded-1 p-2" min="1" max="100" placeholder="10" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label x-small fw-bold text-uppercase text-secondary">Valid From</label>
                                        <input type="date" name="from" class="form-control rounded-1 p-2" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label x-small fw-bold text-uppercase text-secondary">Valid To</label>
                                        <input type="date" name="to" class="form-control rounded-1 p-2" required>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" onclick="submitCreatePromo()" class="btn btn-dark w-100 fw-bold py-2">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <hr class="text-light my-4">

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="font-serif fw-bold m-0">All Promotions</h5>
                            <button onclick="loadPromotionsList()" class="btn btn-sm btn-outline-secondary">Refresh List</button>
                        </div>

                        <div id="promosResult">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Code</th>
                                        <th class="text-center py-3">Discount</th>
                                        <th class="py-3">Valid Period</th>
                                        <th class="text-center py-3">Status</th>
                                    </tr>
                                    </thead>
                                    <tbody id="promosBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="promoLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                    <div id="roiSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Marketing ROI Analysis</h3>
                        <p class="text-secondary small mb-4">Evaluate the profitability of your marketing campaigns.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-4">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Hotel ID</label>
                                <input type="number" id="roiHotelId" class="form-control rounded-1 p-2" placeholder="e.g. 1" value="1">
                                <div class="form-text x-small">Leave 0 to analyze network-wide (if SQL allows) or specific ID.</div>
                            </div>
                            <div class="col-md-3">
                                <button onclick="loadRoiReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Calculate ROI
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="roiResult" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Campaign Type</th>
                                        <th class="py-3">Duration</th>
                                        <th class="text-end py-3">Cost</th>
                                        <th class="text-end py-3">Revenue</th>
                                        <th class="text-center py-3">Orders</th>
                                        <th class="text-end pe-3 py-3 fw-bold">ROI %</th>
                                    </tr>
                                    </thead>
                                    <tbody id="roiBody">
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-3 x-small text-muted fst-italic">
                                * ROI = (Revenue - Cost) / Cost * 100. Positive ROI means profit.
                            </div>
                        </div>

                        <div id="roiLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-secondary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="script">

    // --- NAVIGATION ---
    function showSection(section) {
        // Додаємо roiSection у масив
        const sections = [
            'plSection', 'servicesSection', 'empStatsSection',
            'scheduleSection', 'payrollSection', 'occupancySection',
            'cancellationsSection', 'sentimentSection', 'promosSection',
            'roiSection' // Нове
        ];

        sections.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        });

        const err = document.getElementById('commonError');
        if(err) err.style.display = 'none';

        // ... (попередні умови) ...
        if (section === 'pl') document.getElementById('plSection').style.display = 'block';
        // ... інші секції ...
        else if (section === 'promos') {
            document.getElementById('promosSection').style.display = 'block';
            loadPromotionsList();
        }
        else if (section === 'roi') document.getElementById('roiSection').style.display = 'block'; // Нове
    }

    // --- 10. MARKETING ROI REPORT (OWNER) ---
    async function loadRoiReport() {
        const hotelId = document.getElementById('roiHotelId').value;
        const resultDiv = document.getElementById('roiResult');
        const loader = document.getElementById('roiLoading');

        if (!hotelId) {
            alert("Please enter Hotel ID");
            return;
        }

        resultDiv.style.display = 'none';
        loader.style.display = 'block';

        try {
            // Виклик API
            const response = await fetch(`/api/management/owner/roi?hotelId=${hotelId}`);

            if (response.ok) {
                const data = await response.json();
                // Очікуємо поля з SQL: campaign_type, start_date, end_date, cost, revenue, orders, roi

                const tbody = document.getElementById('roiBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No campaign data found.</td></tr>';
                } else {
                    data.forEach(row => {
                        // Визначаємо колір ROI
                        let roiClass = 'text-muted';
                        let roiIcon = '';
                        const roiVal = parseFloat(row.roi);

                        if (roiVal > 0) {
                            roiClass = 'text-success fw-bold';
                            roiIcon = '▲ ';
                        } else if (roiVal < 0) {
                            roiClass = 'text-danger fw-bold';
                            roiIcon = '▼ ';
                        }

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 fw-bold text-dark text-capitalize">${row.campaign_type}</td>
                                <td class="small text-secondary">
                                    ${row.start_date} <span class="mx-1">&rarr;</span> ${row.end_date}
                                </td>
                                <td class="text-end text-danger font-monospace">-${row.cost} ₴</td>
                                <td class="text-end text-success font-monospace">+${row.revenue} ₴</td>
                                <td class="text-center">${row.orders}</td>
                                <td class="text-end pe-3 ${roiClass}">
                                    ${roiIcon}${row.roi}%
                                </td>
                            </tr>
                        `;
                    });
                }

                loader.style.display = 'none';
                resultDiv.style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
            alert("Error: " + e.message);
        }
    }

    // --- 9. PROMOTIONS MANAGEMENT (OWNER) ---

    // А. Завантаження списку
    async function loadPromotionsList() {
        const tbody = document.getElementById('promosBody');
        const loader = document.getElementById('promoLoading');

        // Очищаємо таблицю, але не видаляємо сам елемент tbody
        tbody.innerHTML = '';
        loader.style.display = 'block';

        try {
            const response = await fetch('/api/management/owner/promotions');
            if (response.ok) {
                const data = await response.json();

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No promotions created yet.</td></tr>';
                } else {
                    const today = new Date().toISOString().split('T')[0];

                    data.forEach(promo => {
                        // Визначаємо статус
                        let statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                        if (promo.valid_to < today) {
                            statusBadge = '<span class="badge bg-light text-secondary border">Expired</span>';
                        } else if (promo.valid_from > today) {
                            statusBadge = '<span class="badge bg-info text-dark">Scheduled</span>';
                        } else {
                            statusBadge = '<span class="badge bg-success">Active</span>';
                        }

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 fw-bold font-monospace text-dark">${promo.code}</td>
                                <td class="text-center fw-bold text-success">-${promo.discount_percent}%</td>
                                <td class="small text-secondary">
                                    ${promo.valid_from} <span class="mx-1">&rarr;</span> ${promo.valid_to}
                                </td>
                                <td class="text-center">${statusBadge}</td>
                            </tr>
                        `;
                    });
                }
            } else {
                console.error("Failed to load promotions");
            }
        } catch (e) {
            console.error(e);
            alert("System error loading promotions");
        } finally {
            loader.style.display = 'none';
        }
    }

    // Б. Створення промокоду
    async function submitCreatePromo() {
        const form = document.getElementById('createPromoForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const btn = document.querySelector('button[onclick="submitCreatePromo()"]');

        btn.disabled = true;

        try {
            // Spring Boot очікує параметри @RequestParam, тому FormData підходить ідеально
            const response = await fetch('/api/management/owner/promotions', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert("Promotion created successfully!");
                form.reset();
                loadPromotionsList(); // Оновлюємо таблицю
            } else {
                const text = await response.text();
                [cite_start]// SQL тригер trg_validate_promocode може повернути помилку (дати, відсотки) [cite: 1478]
                alert("Error: " + text);
            }
        } catch (e) {
            console.error(e);
            alert("System error");
        } finally {
            btn.disabled = false;
        }
    }

    // В. Видалення промокоду
    async function deletePromotion(id) {
        if (!confirm("Delete this promotion? If clients have used it, deletion might fail.")) return;

        try {
            const response = await fetch(`/api/management/owner/promotions/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadPromotionsList();
            } else {
                alert("Cannot delete: " + await response.text());
            }
        } catch (e) {
            console.error(e);
            alert("System error");
        }
    }

    // ... (попередні функції залишаються без змін) ...

    // --- 8. SENTIMENT REPORT (OWNER) ---
    async function loadSentimentReport() {
        const hotelId = document.getElementById('sentHotelId').value;
        const resultDiv = document.getElementById('sentimentResult');
        const loader = document.getElementById('sentLoading');

        if (!hotelId) {
            alert("Please enter Hotel ID");
            return;
        }

        resultDiv.style.display = 'none';
        loader.style.display = 'block';

        try {
            // Виклик API: /owner/sentiment
            const response = await fetch(`/api/management/owner/sentiment?hotelId=${hotelId}`);

            if (response.ok) {
                const data = await response.json(); // Очікуємо масив: employee_name, review_date, rating, sentiment, comment
                const tbody = document.getElementById('sentimentBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No reviews found for this hotel.</td></tr>';
                } else {
                    data.forEach(row => {
                        // Визначаємо колір бейджа настрою (логіка SQL: >=4 Pos, 3 Neu, <3 Neg)
                        let sentimentBadge = 'bg-secondary';
                        if (row.sentiment === 'Позитивний' || row.sentiment === 'Positive') sentimentBadge = 'bg-success';
                        else if (row.sentiment === 'Негативний' || row.sentiment === 'Negative') sentimentBadge = 'bg-danger';
                        else sentimentBadge = 'bg-warning text-dark';

                        // Форматуємо зірки
                        const stars = '★'.repeat(row.rating) + '☆'.repeat(5 - row.rating);

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 text-secondary small">${row.review_date}</td>
                                <td class="fw-bold text-dark small">${row.employee_name}</td>
                                <td class="text-center text-warning" style="letter-spacing: 2px;">${stars}</td>
                                <td class="text-center">
                                    <span class="badge ${sentimentBadge} fw-normal text-uppercase x-small px-2">${row.sentiment}</span>
                                </td>
                                <td class="pe-3 small fst-italic text-secondary">"${row.comment}"</td>
                            </tr>
                        `;
                    });
                }

                loader.style.display = 'none';
                resultDiv.style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
            alert("Error: " + e.message);
        }
    }

    // ... (попередні функції залишаються без змін) ...

    // --- 7. CANCELLATIONS REPORT (OWNER) ---
    async function loadCancellationsReport() {
        const hotelId = document.getElementById('cancHotelId').value;
        const start = document.getElementById('cancStart').value;
        const end = document.getElementById('cancEnd').value;
        const resultDiv = document.getElementById('cancellationsResult');
        const loader = document.getElementById('cancLoading');

        if (!hotelId || !start || !end) {
            alert("Please fill all fields");
            return;
        }

        resultDiv.style.display = 'none';
        loader.style.display = 'block';

        try {
            // Виклик API: /owner/cancellations
            const response = await fetch(`/api/management/owner/cancellations?hotelId=${hotelId}&start=${start}&end=${end}`);

            if (response.ok) {
                const data = await response.json(); // Очікуємо масив: cancel_reason, cancellation_count, percentage_of_total
                const tbody = document.getElementById('cancellationsBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-muted">No cancellations found for this period.</td></tr>';
                } else {
                    data.forEach(row => {
                        const percent = row.percentage_of_total || 0;

                        // Червона смужка для найчастіших причин
                        let barClass = 'bg-secondary';
                        if (percent > 30) barClass = 'bg-danger';
                        else if (percent > 15) barClass = 'bg-warning text-dark';

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 fw-bold text-dark text-capitalize">
                                    "${row.cancel_reason}"
                                </td>
                                <td class="text-center fw-bold">${row.cancellation_count}</td>
                                <td class="pe-3">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar ${barClass}" role="progressbar" style="width: ${percent}%" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span class="ms-3 fw-bold small text-dark" style="width: 50px; text-align: right;">${percent}%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }

                loader.style.display = 'none';
                resultDiv.style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
            alert("Error: " + e.message);
        }
    }

    // ... (попередні функції залишаються без змін) ...

    // --- 6. OCCUPANCY REPORT (OWNER) ---
    async function loadOccupancyReport() {
        const hotelId = document.getElementById('occHotelId').value;
        const start = document.getElementById('occStart').value;
        const end = document.getElementById('occEnd').value;
        const resultDiv = document.getElementById('occupancyResult');
        const loader = document.getElementById('occLoading');

        if (!hotelId || !start || !end) {
            alert("Please fill all fields");
            return;
        }

        resultDiv.style.display = 'none';
        loader.style.display = 'block';

        try {
            // Виклик API: /owner/occupancy-category
            const response = await fetch(`/api/management/owner/occupancy-category?hotelId=${hotelId}&start=${start}&end=${end}`);

            if (response.ok) {
                const data = await response.json(); // Очікуємо масив: comfort_level, total_capacity, occupied_days, occupancy_rate
                const tbody = document.getElementById('occupancyBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No data found for this period.</td></tr>';
                } else {
                    data.forEach(row => {
                        const rate = row.occupancy_rate || 0;

                        // Колір прогрес-бару залежно від завантаженості
                        let barClass = 'bg-info';
                        if (rate > 80) barClass = 'bg-success';      // Висока ефективність
                        else if (rate < 30) barClass = 'bg-warning'; // Низька ефективність (простій)

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 fw-bold text-dark text-uppercase small">${row.comfort_level}</td>
                                <td class="text-center text-secondary">${row.total_capacity}</td>
                                <td class="text-center fw-bold text-dark">${row.occupied_days}</td>
                                <td class="pe-3">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar ${barClass}" role="progressbar" style="width: ${rate}%" aria-valuenow="${rate}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span class="ms-3 fw-bold small text-dark" style="width: 40px; text-align: right;">${rate}%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }

                loader.style.display = 'none';
                resultDiv.style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
            alert("Error: " + e.message);
        }
    }

    // ... (попередні функції loadFinancials, loadServicesReport і т.д. залишаються без змін) ...

    // --- 5. PAYROLL REPORT (OWNER) ---
    async function loadPayrollReport() {
        const hotelId = document.getElementById('payHotelId').value;
        const resultDiv = document.getElementById('payrollResult');
        const loader = document.getElementById('payLoading');

        if (!hotelId) {
            alert("Please enter Hotel ID");
            return;
        }

        resultDiv.style.display = 'none';
        loader.style.display = 'block';

        try {
            // Виклик API
            const response = await fetch(`/api/management/owner/payroll?hotelId=${hotelId}`);

            if (response.ok) {
                const data = await response.json(); // Список об'єктів: employee_name, position, base_salary, net_payout
                const tbody = document.getElementById('payrollBody');
                const totalEl = document.getElementById('payrollTotal');
                tbody.innerHTML = '';

                let grandTotal = 0;

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No payroll data found for this hotel.</td></tr>';
                } else {
                    data.forEach(row => {
                        // Підсумовуємо загальну суму виплат
                        grandTotal += (row.net_payout || 0);

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 fw-bold text-dark">${row.employee_name}</td>
                                <td><span class="badge bg-light text-secondary border fw-normal x-small text-uppercase">${row.position}</span></td>
                                <td class="text-end font-monospace text-secondary">${row.base_salary} ₴</td>
                                <td class="text-end pe-3 font-monospace fw-bold text-success">${row.net_payout} ₴</td>
                            </tr>
                        `;
                    });
                }

                // Оновлюємо загальну суму в футері таблиці
                totalEl.innerText = grandTotal.toFixed(2) + ' ₴';

                loader.style.display = 'none';
                resultDiv.style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
            alert("Error: " + e.message);
        }
    }

    // --- 4. SCHEDULE REPORT (OWNER) ---
    async function loadOwnerSchedule() {
        const hotelId = document.getElementById('schHotelId').value;
        const date = document.getElementById('schDate').value;
        const resultDiv = document.getElementById('scheduleResult');
        const loader = document.getElementById('schLoading');

        if (!hotelId || !date) {
            alert("Please enter Hotel ID and Date");
            return;
        }

        resultDiv.style.display = 'none';
        loader.style.display = 'block';

        try {
            // Виклик вашого нового ендпоінту
            const response = await fetch(`/api/management/owner/schedule?hotelId=${hotelId}&date=${date}`);

            if (response.ok) {
                const data = await response.json(); // Очікуємо список змін
                const tbody = document.getElementById('scheduleBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No shifts scheduled for this date.</td></tr>';
                } else {
                    data.forEach(row => {
                        // row має поля: employee_name, position, start_time, end_time, shift_duration
                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 fw-bold text-dark">${row.employee_name}</td>
                                <td><span class="badge bg-light text-secondary border fw-normal x-small text-uppercase">${row.position}</span></td>
                                <td class="text-center font-monospace">${row.start_time}</td>
                                <td class="text-center font-monospace">${row.end_time}</td>
                                <td class="text-end pe-3 fw-bold text-success">${row.shift_duration} h</td>
                            </tr>
                        `;
                    });
                }

                loader.style.display = 'none';
                resultDiv.style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
            alert("Error: " + e.message);
        }
    }

    // --- 3. EMPLOYEE STATS (OWNER) ---

    // Крок 1: Завантажити список працівників для вибраного готелю
    async function loadOwnerStaffList() {
        const hotelId = document.getElementById('empHotelId').value;
        const select = document.getElementById('empSelect');
        const btn = document.querySelector('button[onclick="loadOwnerStaffList()"]');

        if (!hotelId) { alert("Enter Hotel ID"); return; }

        btn.disabled = true;
        btn.innerText = "...";
        select.innerHTML = '<option selected disabled>Loading...</option>';

        try {
            // Використовуємо новий ендпоінт для списку
            const response = await fetch(`/api/management/owner/staff-list?hotelId=${hotelId}`);
            if (response.ok) {
                const staff = await response.json();
                select.innerHTML = '<option value="" selected disabled>Select an employee...</option>';

                if (staff.length === 0) {
                    select.innerHTML = '<option disabled>No staff found in this hotel</option>';
                } else {
                    staff.forEach(emp => {
                        select.innerHTML += `<option value="${emp.employee_id}">${emp.first_name} ${emp.last_name} (${emp.position})</option>`;
                    });
                }
            } else {
                alert("Error fetching staff");
            }
        } catch (e) {
            console.error(e);
            alert("System error");
        } finally {
            btn.disabled = false;
            btn.innerText = "Load";
        }
    }

    // Крок 2: Отримати статистику по вибраному працівнику
    async function loadEmployeeStats() {
        const hotelId = document.getElementById('empHotelId').value;
        const employeeId = document.getElementById('empSelect').value;
        const resultDiv = document.getElementById('empStatsResult');
        const loader = document.getElementById('empLoading');

        if (!hotelId || !employeeId) {
            alert("Please select Hotel and Employee");
            return;
        }

        resultDiv.style.display = 'none';
        loader.style.display = 'block';

        try {
            const response = await fetch(`/api/management/owner/employee-stats?hotelId=${hotelId}&employeeId=${employeeId}`);

            if (response.ok) {
                const data = await response.json();

                // Заповнення даних
                document.getElementById('esName').innerText = data.full_name;
                document.getElementById('esPosition').innerText = data.position;

                // Ініціали для аватарки
                const initials = data.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                document.getElementById('esInitials').innerText = initials;

                document.getElementById('esShifts').innerText = data.shifts_worked;
                document.getElementById('esRating').innerText = data.avg_rating > 0 ? data.avg_rating : 'N/A';

                const complaintsEl = document.getElementById('esComplaints');
                complaintsEl.innerText = data.complaints_count;
                // Підсвічуємо червоним, якщо є скарги
                complaintsEl.className = data.complaints_count > 0 ? 'fs-2 fw-bold text-danger' : 'fs-2 fw-bold text-success';

                const comment = data.last_review_comment;
                document.getElementById('esComment').innerText = comment ? `"${comment}"` : "No recent reviews.";

                loader.style.display = 'none';
                resultDiv.style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
            alert("Error: " + e.message);
        }
    }

    // --- 1. FINANCIALS REPORT (P&L) ---
    async function loadFinancials() {
        const hotelId = document.getElementById('plHotelId').value;
        const start = document.getElementById('plStart').value;
        const end = document.getElementById('plEnd').value;
        const errorDiv = document.getElementById('commonError');

        if (!hotelId || !start || !end) {
            alert("Please fill all fields (Hotel ID, Start Date, End Date)");
            return;
        }

        document.getElementById('plSummary').style.display = 'none';
        document.getElementById('plLoading').style.display = 'block';
        if(errorDiv) errorDiv.style.display = 'none';

        try {
            const response = await fetch(`/api/management/owner/financial-detailed?hotelId=${hotelId}&start=${start}&end=${end}`);

            if (response.ok) {
                const data = await response.json();
                const tbody = document.getElementById('ledgerBody');
                tbody.innerHTML = '';

                let totalIncome = 0;
                let totalExpense = 0;

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No transactions found.</td></tr>';
                } else {
                    data.forEach(row => {
                        const inc = row.income_amount || 0;
                        const exp = row.expense_amount || 0;
                        totalIncome += inc;
                        totalExpense += exp;

                        const incomeClass = inc > 0 ? 'text-success fw-bold' : 'text-muted opacity-25';
                        const expenseClass = exp > 0 ? 'text-danger fw-bold' : 'text-muted opacity-25';
                        const balanceClass = (row.running_balance < 0) ? 'text-danger' : 'text-dark';

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 small text-secondary">${row.operation_date}</td>
                                <td><span class="badge bg-light text-dark border fw-normal x-small text-uppercase">${row.category}</span></td>
                                <td class="small text-dark">${row.description}</td>
                                <td class="text-end ${incomeClass}">${inc > 0 ? '+' + inc : '-'}</td>
                                <td class="text-end ${expenseClass}">${exp > 0 ? '-' + exp : '-'}</td>
                                <td class="text-end pe-3 fw-bold ${balanceClass}">${row.running_balance} ₴</td>
                            </tr>
                        `;
                    });
                }

                document.getElementById('valIncome').innerText = totalIncome.toFixed(2) + ' ₴';
                document.getElementById('valExpenses').innerText = totalExpense.toFixed(2) + ' ₴';
                const netProfit = totalIncome - totalExpense;
                const profitEl = document.getElementById('valProfit');
                profitEl.innerText = netProfit.toFixed(2) + ' ₴';
                profitEl.className = netProfit >= 0 ? 'fs-3 fw-bold text-success' : 'fs-3 fw-bold text-danger';

                document.getElementById('plLoading').style.display = 'none';
                document.getElementById('plSummary').style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            document.getElementById('plLoading').style.display = 'none';
            if(errorDiv) {
                errorDiv.innerText = "Error: " + e.message;
                errorDiv.style.display = 'block';
            } else {
                alert("Error: " + e.message);
            }
        }
    }

    // --- 2. SERVICE POPULARITY REPORT (NEW) ---
    async function loadServicesReport() {
        const hotelId = document.getElementById('srvHotelId').value;
        const start = document.getElementById('srvStart').value;
        const end = document.getElementById('srvEnd').value;
        const errorDiv = document.getElementById('commonError'); // Можна використати спільний блок помилок

        if (!hotelId || !start || !end) {
            alert("Please fill Hotel ID and Dates");
            return;
        }

        document.getElementById('servicesSummary').style.display = 'none';
        document.getElementById('srvLoading').style.display = 'block';

        try {
            // Запит до нового ендпоінту
            const response = await fetch(`/api/management/owner/service-popularity?hotelId=${hotelId}&start=${start}&end=${end}`);

            if (response.ok) {
                const data = await response.json();
                const tbody = document.getElementById('servicesBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No service usage recorded for this period.</td></tr>';
                } else {
                    data.forEach(item => {
                        // item.popularity_rank, item.service_name, item.usage_count, item.total_revenue

                        // Додаємо іконку кубка для ТОП-1
                        let rankHtml = `<span class="fw-bold text-secondary">#${item.popularity_rank}</span>`;
                        if(item.popularity_rank === 1) {
                            rankHtml = `<span class="badge bg-warning text-dark border border-warning">🏆 #1</span>`;
                        }

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3">${rankHtml}</td>
                                <td class="fw-bold text-dark">${item.service_name}</td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark border fw-normal px-3">${item.usage_count} times</span>
                                </td>
                                <td class="text-end pe-3 fw-bold text-success">+${item.total_revenue} ₴</td>
                            </tr>
                        `;
                    });
                }

                document.getElementById('srvLoading').style.display = 'none';
                document.getElementById('servicesSummary').style.display = 'block';
            } else {
                throw new Error(await response.text());
            }
        } catch (e) {
            console.error(e);
            document.getElementById('srvLoading').style.display = 'none';
            alert("Error loading service report: " + e.message);
        }
    }

</script>

<style>
    .x-small { font-size: 0.7rem; letter-spacing: 0.05em; }
    .hover-dark:hover { color: #111827 !important; background-color: #f3f4f6; }
</style>

</body>
</html>