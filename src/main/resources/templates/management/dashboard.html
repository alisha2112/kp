<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Management Dashboard - HotelGroup</title>
</head>
<body>

<div layout:fragment="content" class="bg-light py-5">
    <div class="container" style="max-width: 1100px;">

        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="font-serif fw-bold h2 m-0 text-dark">Management Panel</h1>
                <p class="text-secondary small mb-0">Analytics & Staff Control</p>
            </div>
            <span class="badge bg-dark text-white border border-light-subtle fw-normal rounded-1 px-3 py-2 text-uppercase" style="letter-spacing: 0.1em;">
                Manager Access
            </span>
        </div>

        <div class="row g-4">

            <div class="col-md-3">
                <div class="bg-white p-3 shadow-sm border border-light-subtle rounded-1 h-100">
                    <div class="d-flex flex-column gap-2 sticky-top" style="top: 100px;">

                        <div class="text-secondary x-small fw-bold text-uppercase mb-2 ps-2">Analytics</div>

                        <button onclick="showSection('financial')" class="btn btn-luxury w-100 text-start d-flex justify-content-between align-items-center mb-2">
                            <span>Financial Report</span>
                            <span>&rsaquo;</span>
                        </button>

                        <button onclick="showSection('occupancy')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Occupancy
                        </button>

                        <button onclick="showSection('feedback')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Customer Feedback
                        </button>

                        <div class="text-secondary x-small fw-bold text-uppercase mt-3 mb-2 ps-2">Staff</div>

                        <button class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2" disabled>
                            Employees
                        </button>

                        <button class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2" disabled>
                            Workload
                        </button>

                        <button onclick="logoutUser()" class="btn btn-outline-danger w-100 text-start border-0 mt-2">
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="bg-white p-5 shadow-sm border-top border-4 border-dark rounded-1" style="min-height: 500px;">

                    <div id="financialSection">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Financial Report</h3>
                        <p class="text-secondary small mb-4">Select a period to analyze income, expenses, and debts.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="finStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="finEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-2">
                                <button onclick="loadFinancialReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Generate
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="finReportResult" style="display: none;">
                            <div class="row g-4 text-center">
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Total Income</div>
                                        <div class="fs-3 fw-bold text-success" id="valIncome">0 ₴</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Transactions</div>
                                        <div class="fs-3 fw-bold text-dark" id="valCount">0</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Total Debt</div>
                                        <div class="fs-3 fw-bold text-danger" id="valDebt">0 ₴</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="occupancySection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Occupancy Analysis</h3>
                        <p class="text-secondary small mb-4">Check room usage efficiency for your hotel.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="occStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="occEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-2">
                                <button onclick="loadOccupancyReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Analyze
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="occReportResult" style="display: none;">
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100 d-flex flex-column justify-content-center text-center">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Occupancy Rate</div>
                                        <div class="display-4 fw-bold text-dark mb-2" id="valOccPercent">0%</div>
                                        <div class="progress" role="progressbar" style="height: 10px;">
                                            <div id="occProgressBar" class="progress-bar bg-dark" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="row g-3 h-100">
                                        <div class="col-12">
                                            <div class="p-3 border border-light-subtle rounded-1 bg-white h-100 d-flex justify-content-between align-items-center">
                                                <span class="text-secondary x-small text-uppercase fw-bold">Total Rooms</span>
                                                <span class="fs-5 fw-bold text-dark" id="valTotalRooms">0</span>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="p-3 border border-light-subtle rounded-1 bg-white h-100 d-flex justify-content-between align-items-center">
                                                <span class="text-secondary x-small text-uppercase fw-bold">Occupied Days</span>
                                                <span class="fs-5 fw-bold text-success" id="valOccDays">0</span>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="p-3 border border-light-subtle rounded-1 bg-white h-100 d-flex justify-content-between align-items-center">
                                                <span class="text-secondary x-small text-uppercase fw-bold">Available Days</span>
                                                <span class="fs-5 fw-bold text-muted" id="valAvailDays">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="feedbackSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Customer Feedback</h3>
                        <p class="text-secondary small mb-4">Analyze ratings and complaints for the selected period.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="feedStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="feedEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-2">
                                <button onclick="loadFeedbackReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Get Report
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="feedReportResult" style="display: none;">
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100 text-center">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Average Rating</div>
                                        <div class="display-4 fw-bold text-warning mb-1" id="valAvgRating">0.0</div>
                                        <div class="text-warning fs-5" id="valStars">★★★★★</div>
                                        <div class="text-muted small mt-2">Based on <span id="valReviewCount" class="fw-bold text-dark">0</span> reviews</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-white h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-3">Key Complaints (< 4 stars)</div>
                                        <div class="bg-light p-3 rounded border border-light-subtle small text-secondary fst-italic" id="valComplaints" style="max-height: 150px; overflow-y: auto;">
                                            No complaints recorded for this period.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="commonLoading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-dark" role="status"></div>
                    </div>
                    <div id="commonError" class="alert alert-danger mt-3 small" style="display: none;"></div>

                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="script">

    // --- NAVIGATION ---
    function showSection(section) {
        document.getElementById('financialSection').style.display = 'none';
        document.getElementById('occupancySection').style.display = 'none';
        document.getElementById('feedbackSection').style.display = 'none';

        if (section === 'financial') {
            document.getElementById('financialSection').style.display = 'block';
        } else if (section === 'occupancy') {
            document.getElementById('occupancySection').style.display = 'block';
        } else if (section === 'feedback') {
            document.getElementById('feedbackSection').style.display = 'block';
        }

        document.getElementById('commonError').style.display = 'none';
    }

    // --- FINANCIAL REPORT ---
    async function loadFinancialReport() {
        const start = document.getElementById('finStart').value;
        const end = document.getElementById('finEnd').value;
        if(!start || !end) { alert("Select dates"); return; }

        toggleLoading(true);

        try {
            const response = await fetch(`/api/management/reports/financial?start=${start}&end=${end}`);
            if (response.ok) {
                const data = await response.json();
                document.getElementById('valIncome').innerText = data.total_income + ' ₴';
                document.getElementById('valCount').innerText = data.transactions_count;
                document.getElementById('valDebt').innerText = data.total_debt + ' ₴';
                document.getElementById('finReportResult').style.display = 'block';
            } else {
                showError(await response.text());
            }
        } catch (e) {
            showError("System error");
        } finally {
            toggleLoading(false);
        }
    }

    // --- OCCUPANCY REPORT ---
    async function loadOccupancyReport() {
        const start = document.getElementById('occStart').value;
        const end = document.getElementById('occEnd').value;
        if(!start || !end) { alert("Select dates"); return; }

        toggleLoading(true);

        try {
            const response = await fetch(`/api/management/reports/occupancy?start=${start}&end=${end}`);
            if (response.ok) {
                const data = await response.json();

                document.getElementById('valTotalRooms').innerText = data.total_rooms;
                document.getElementById('valOccDays').innerText = data.occupied_days;
                document.getElementById('valAvailDays').innerText = data.available_days;

                const percent = data.occupancy_percentage;
                document.getElementById('valOccPercent').innerText = percent + '%';

                const bar = document.getElementById('occProgressBar');
                bar.style.width = percent + '%';

                if (percent > 80) bar.className = 'progress-bar bg-success';
                else if (percent > 50) bar.className = 'progress-bar bg-dark';
                else bar.className = 'progress-bar bg-warning text-dark';

                document.getElementById('occReportResult').style.display = 'block';
            } else {
                showError(await response.text());
            }
        } catch (e) {
            showError("System error");
        } finally {
            toggleLoading(false);
        }
    }

    // --- CUSTOMER FEEDBACK REPORT (НОВЕ) ---
    async function loadFeedbackReport() {
        const start = document.getElementById('feedStart').value;
        const end = document.getElementById('feedEnd').value;
        if(!start || !end) { alert("Select dates"); return; }

        toggleLoading(true);

        try {
            const response = await fetch(`/api/management/reports/customer-service?start=${start}&end=${end}`);
            if (response.ok) {
                const data = await response.json();
                // SQL повертає: reviews_count, avg_rating, complaints_list (text)

                document.getElementById('valReviewCount').innerText = data.reviews_count;
                document.getElementById('valAvgRating').innerText = data.avg_rating || '0.0';

                // Візуалізація зірок
                const rating = Math.round(data.avg_rating || 0);
                let starsHtml = '';
                for(let i=0; i<5; i++) {
                    if(i < rating) starsHtml += '★';
                    else starsHtml += '<span class="text-muted opacity-25">★</span>';
                }
                document.getElementById('valStars').innerHTML = starsHtml;

                // Скарги
                const complaints = data.complaints_list;
                if (complaints && complaints !== 'Скарг немає') {
                    // Можемо розбити через крапку з комою для кращого вигляду, якщо потрібно
                    document.getElementById('valComplaints').innerText = complaints;
                } else {
                    document.getElementById('valComplaints').innerText = "No significant complaints recorded for this period.";
                }

                document.getElementById('feedReportResult').style.display = 'block';
            } else {
                showError(await response.text());
            }
        } catch (e) {
            showError("System error");
        } finally {
            toggleLoading(false);
        }
    }

    // --- HELPERS ---
    function toggleLoading(show) {
        document.getElementById('commonLoading').style.display = show ? 'block' : 'none';
        document.getElementById('commonError').style.display = 'none';
    }

    function showError(msg) {
        const errDiv = document.getElementById('commonError');
        errDiv.innerText = "Error: " + msg;
        errDiv.style.display = 'block';
    }

</script>

<style>
    .x-small { font-size: 0.7rem; letter-spacing: 0.05em; }
    .hover-dark:hover { color: #111827 !important; background-color: #f3f4f6; }
</style>

</body>
</html>