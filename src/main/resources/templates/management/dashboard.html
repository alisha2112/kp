<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Management Dashboard - HotelGroup</title>
</head>
<body>

<div layout:fragment="content" class="bg-light py-5">
    <div class="container" style="max-width: 1100px;">

        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="font-serif fw-bold h2 m-0 text-dark">Management Panel</h1>
                <p class="text-secondary small mb-0">Analytics & Staff Control</p>
            </div>
            <span class="badge bg-dark text-white border border-light-subtle fw-normal rounded-1 px-3 py-2 text-uppercase" style="letter-spacing: 0.1em;">
                Manager Access
            </span>
        </div>

        <div class="row g-4">

            <div class="col-md-3">
                <div class="bg-white p-3 shadow-sm border border-light-subtle rounded-1 h-100">
                    <div class="d-flex flex-column gap-2 sticky-top" style="top: 100px;">

                        <div class="text-secondary x-small fw-bold text-uppercase mb-2 ps-2">Analytics</div>

                        <button onclick="showSection('financial')" class="btn btn-luxury w-100 text-start d-flex justify-content-between align-items-center mb-2">
                            <span>Financial Report</span>
                            <span>&rsaquo;</span>
                        </button>

                        <button onclick="showSection('occupancy')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Occupancy
                        </button>

                        <button onclick="showSection('feedback')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Customer Feedback
                        </button>

                        <div class="text-secondary x-small fw-bold text-uppercase mt-3 mb-2 ps-2">Staff</div>

                        <button onclick="loadStaff()" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Employees
                        </button>

                        <button onclick="showSection('workload')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Workload
                        </button>

                        <button onclick="showSection('performance')" class="btn btn-outline-luxury w-100 text-start border-0 text-secondary hover-dark mb-2">
                            Performance KPI
                        </button>

                        <button onclick="logoutUser()" class="btn btn-outline-danger w-100 text-start border-0 mt-2">
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="bg-white p-5 shadow-sm border-top border-4 border-dark rounded-1" style="min-height: 500px;">

                    <div id="financialSection">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Financial Report</h3>
                        <p class="text-secondary small mb-4">Select a period to analyze income, expenses, and debts.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="finStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="finEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-2">
                                <button onclick="loadFinancialReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Generate
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="finReportResult" style="display: none;">
                            <div class="row g-4 text-center">
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Total Income</div>
                                        <div class="fs-3 fw-bold text-success" id="valIncome">0 ₴</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Transactions</div>
                                        <div class="fs-3 fw-bold text-dark" id="valCount">0</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Total Debt</div>
                                        <div class="fs-3 fw-bold text-danger" id="valDebt">0 ₴</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="occupancySection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Occupancy Analysis</h3>
                        <p class="text-secondary small mb-4">Check room usage efficiency for your hotel.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="occStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="occEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-2">
                                <button onclick="loadOccupancyReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Analyze
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="occReportResult" style="display: none;">
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100 d-flex flex-column justify-content-center text-center">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Occupancy Rate</div>
                                        <div class="display-4 fw-bold text-dark mb-2" id="valOccPercent">0%</div>
                                        <div class="progress" role="progressbar" style="height: 10px;">
                                            <div id="occProgressBar" class="progress-bar bg-dark" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="row g-3 h-100">
                                        <div class="col-12">
                                            <div class="p-3 border border-light-subtle rounded-1 bg-white h-100 d-flex justify-content-between align-items-center">
                                                <span class="text-secondary x-small text-uppercase fw-bold">Total Rooms</span>
                                                <span class="fs-5 fw-bold text-dark" id="valTotalRooms">0</span>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="p-3 border border-light-subtle rounded-1 bg-white h-100 d-flex justify-content-between align-items-center">
                                                <span class="text-secondary x-small text-uppercase fw-bold">Occupied Days</span>
                                                <span class="fs-5 fw-bold text-success" id="valOccDays">0</span>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="p-3 border border-light-subtle rounded-1 bg-white h-100 d-flex justify-content-between align-items-center">
                                                <span class="text-secondary x-small text-uppercase fw-bold">Available Days</span>
                                                <span class="fs-5 fw-bold text-muted" id="valAvailDays">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="feedbackSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Customer Feedback</h3>
                        <p class="text-secondary small mb-4">Analyze ratings and complaints for the selected period.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="feedStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="feedEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-2">
                                <button onclick="loadFeedbackReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Get Report
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="feedReportResult" style="display: none;">
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-light h-100 text-center">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-2">Average Rating</div>
                                        <div class="display-4 fw-bold text-warning mb-1" id="valAvgRating">0.0</div>
                                        <div class="text-warning fs-5" id="valStars">★★★★★</div>
                                        <div class="text-muted small mt-2">Based on <span id="valReviewCount" class="fw-bold text-dark">0</span> reviews</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-4 border border-light-subtle rounded-1 bg-white h-100">
                                        <div class="text-secondary x-small text-uppercase fw-bold mb-3">Key Complaints (< 4 stars)</div>
                                        <div class="bg-light p-3 rounded border border-light-subtle small text-secondary fst-italic" id="valComplaints" style="max-height: 150px; overflow-y: auto;">
                                            No complaints recorded for this period.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="staffSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h3 class="font-serif fw-bold h4 m-0 text-dark">Staff Management</h3>
                                <p class="text-secondary small mb-0">Manage your hotel team.</p>
                            </div>
                            <div>
                                <button onclick="openCleaningModal()" class="btn btn-outline-dark fw-bold text-uppercase me-2" style="font-size: 0.8rem;">
                                    Assign Cleaning
                                </button>

                                <button onclick="openScheduleModal()" class="btn btn-outline-dark fw-bold text-uppercase me-2" style="font-size: 0.8rem;">
                                    View Schedule
                                </button>

                                <button onclick="openHireModal()" class="btn btn-dark fw-bold text-uppercase" style="font-size: 0.8rem;">
                                    + Hire Employee
                                </button>
                            </div>
                        </div>

                        <div id="staffTableArea">
                            <div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>
                        </div>
                    </div>

                    <div id="workloadSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Staff Workload Analysis</h3>
                        <p class="text-secondary small mb-4">Monitor employee hours and shifts efficiency.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="workStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="workEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-2">
                                <button onclick="loadWorkloadReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Analyze
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="workloadResult" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border">
                                    <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-3">Employee</th>
                                        <th class="py-3">Position</th>
                                        <th class="text-center py-3">Total Shifts</th>
                                        <th class="text-center py-3">Total Hours</th>
                                        <th class="pe-3 py-3 text-end">Efficiency</th>
                                    </tr>
                                    </thead>
                                    <tbody id="workloadTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="performanceSection" style="display: none;">
                        <h3 class="font-serif fw-bold h4 mb-4 text-dark">Staff Performance KPI</h3>
                        <p class="text-secondary small mb-4">Evaluate task completion rates and customer ratings.</p>

                        <div class="row g-3 align-items-end mb-5">
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" id="perfStart" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" id="perfEnd" class="form-control rounded-1 p-2">
                            </div>
                            <div class="col-md-2">
                                <button onclick="loadPerformanceReport()" class="btn btn-dark w-100 fw-bold py-2 text-uppercase" style="font-size: 0.8rem;">
                                    Analyze
                                </button>
                            </div>
                        </div>

                        <hr class="text-light my-4">

                        <div id="performanceResult" style="display: none;">
                            <div class="row g-4">
                                <div class="col-12">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle border">
                                            <thead class="table-light small text-uppercase">
                                            <tr>
                                                <th class="ps-3 py-3">Employee</th>
                                                <th class="py-3">Position</th>
                                                <th class="text-center py-3">Tasks Completed</th>
                                                <th class="text-center py-3">Avg Rating</th>
                                                <th class="pe-3 py-3 text-end">Score</th>
                                            </tr>
                                            </thead>
                                            <tbody id="performanceTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="commonLoading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-dark" role="status"></div>
                    </div>
                    <div id="commonError" class="alert alert-danger mt-3 small" style="display: none;"></div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="hireModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-1 border-0 shadow-lg">
                <div class="modal-header border-bottom border-light-subtle">
                    <h5 class="modal-title font-serif fw-bold">Hire New Employee</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="hireForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Last Name</label>
                                <input type="text" name="lastName" class="form-control rounded-1" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">First Name</label>
                                <input type="text" name="firstName" class="form-control rounded-1" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Middle Name</label>
                                <input type="text" name="middleName" class="form-control rounded-1">
                            </div>

                            <div class="col-12">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Phone</label>
                                <input type="text" name="phone" class="form-control rounded-1" placeholder="+380..." required>
                            </div>

                            <div class="col-12">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Position</label>
                                <select name="position" class="form-select rounded-1" required>
                                    <option value="" selected disabled>Select Role</option>
                                    <option value="Administrator">Administrator</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Cleaner">Cleaner</option>
                                    <option value="Accountant">Accountant</option>
                                    <option value="Receptionist">Receptionist</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
                    <button type="button" class="btn btn-light btn-sm text-uppercase fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" onclick="submitHire()" class="btn btn-dark btn-sm text-uppercase fw-bold px-4">Hire</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="shiftModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-1 border-0 shadow-lg">
                <div class="modal-header border-bottom border-light-subtle">
                    <h5 class="modal-title font-serif fw-bold">Assign Shift</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-secondary small mb-3">Scheduling for: <strong id="shiftEmpName" class="text-dark">Name</strong></p>
                    <form id="shiftForm">
                        <input type="hidden" id="shiftEmpId" name="id">

                        <div class="mb-3">
                            <label class="form-label x-small fw-bold text-uppercase text-secondary">Date</label>
                            <input type="date" name="date" class="form-control rounded-1" required>
                        </div>

                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">Start Time</label>
                                <input type="time" name="start" class="form-control rounded-1" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label x-small fw-bold text-uppercase text-secondary">End Time</label>
                                <input type="time" name="end" class="form-control rounded-1" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
                    <button type="button" class="btn btn-light btn-sm text-uppercase fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" onclick="submitShift()" class="btn btn-dark btn-sm text-uppercase fw-bold px-4">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="viewScheduleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content rounded-1 border-0 shadow-lg">
            <div class="modal-header border-bottom border-light-subtle">
                <h5 class="modal-title font-serif fw-bold">Daily Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">

                <div class="d-flex align-items-center mb-4">
                    <label class="small fw-bold text-uppercase text-secondary me-3">Select Date:</label>
                    <input type="date" id="scheduleDateInput" class="form-control rounded-1 w-auto me-3">
                    <button onclick="fetchSchedule()" class="btn btn-dark btn-sm text-uppercase fw-bold">Load</button>
                </div>

                <div id="scheduleResultArea">
                    <div class="text-center text-secondary py-4 small">Select a date to view shifts.</div>
                </div>

            </div>
        </div>
        </div>
    </div>
    <div class="modal fade" id="cleaningModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-1 border-0 shadow-lg">
                <div class="modal-header border-bottom border-light-subtle">
                    <h5 class="modal-title font-serif fw-bold">Assign Cleaning Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="cleaningForm">
                        <div class="mb-3">
                            <label class="form-label x-small fw-bold text-uppercase text-secondary">Room Number</label>
                            <input type="number" name="roomNumber" class="form-control rounded-1" placeholder="e.g. 101" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label x-small fw-bold text-uppercase text-secondary">Cleaner</label>
                            <select id="cleanerSelect" name="cleanerId" class="form-select rounded-1" required>
                                <option value="" disabled selected>Loading staff...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label x-small fw-bold text-uppercase text-secondary">Note</label>
                            <textarea name="note" class="form-control rounded-1" rows="2" placeholder="e.g. Guest requested extra towels"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
                    <button type="button" class="btn btn-light btn-sm text-uppercase fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" onclick="submitCleaning()" class="btn btn-dark btn-sm text-uppercase fw-bold px-4">Assign</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script layout:fragment="script">

    // --- NAVIGATION ---
    function showSection(section) {
        const sections = ['financial', 'occupancy', 'feedback', 'staff', 'workload', 'performance']; // <-- Додано performance
        sections.forEach(s => {
            const el = document.getElementById(s + 'Section');
            if(el) el.style.display = 'none';
        });

        const target = document.getElementById(section + 'Section');
        if(target) target.style.display = 'block';

        document.getElementById('commonError').style.display = 'none';
    }

    // --- PERFORMANCE REPORT ---
    async function loadPerformanceReport() {
        const start = document.getElementById('perfStart').value;
        const end = document.getElementById('perfEnd').value;
        if(!start || !end) { alert("Select dates"); return; }

        toggleLoading(true);

        try {
            const response = await fetch(`/api/management/staff/performance?start=${start}&end=${end}`);
            if (response.ok) {
                const data = await response.json();
                const tbody = document.getElementById('performanceTableBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No data found.</td></tr>';
                } else {
                    data.forEach(row => {
                        // Рахуємо умовний Score (наприклад, рейтинг важливіший за кількість)
                        // Якщо рейтингу немає (0), то Score базується тільки на завданнях
                        let scoreHtml = '';
                        if (row.avg_rating > 0) {
                            if(row.avg_rating >= 4.5) scoreHtml = '<span class="badge bg-success">Excellent</span>';
                            else if(row.avg_rating >= 3.5) scoreHtml = '<span class="badge bg-dark">Good</span>';
                            else scoreHtml = '<span class="badge bg-warning text-dark">Review</span>';
                        } else {
                            // Якщо тільки завдання
                            if(row.tasks_completed > 20) scoreHtml = '<span class="badge bg-dark">High Activity</span>';
                            else scoreHtml = '<span class="badge bg-light text-secondary border">Normal</span>';
                        }

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 fw-bold text-dark">${row.full_name}</td>
                                <td><span class="badge bg-light text-dark border fw-normal x-small">${row.position}</span></td>
                                <td class="text-center">${row.tasks_completed}</td>
                                <td class="text-center fw-bold text-warning">
                                    ${row.avg_rating > 0 ? row.avg_rating + ' ★' : '-'}
                                </td>
                                <td class="pe-3 text-end">${scoreHtml}</td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('performanceResult').style.display = 'block';
            } else {
                showError(await response.text());
            }
        } catch (e) {
            showError("System error");
        } finally {
            toggleLoading(false);
        }
    }

    // --- FINANCIAL REPORT ---
    async function loadFinancialReport() {
        const start = document.getElementById('finStart').value;
        const end = document.getElementById('finEnd').value;
        if(!start || !end) { alert("Select dates"); return; }

        toggleLoading(true);

        try {
            const response = await fetch(`/api/management/reports/financial?start=${start}&end=${end}`);
            if (response.ok) {
                const data = await response.json();
                document.getElementById('valIncome').innerText = data.total_income + ' ₴';
                document.getElementById('valCount').innerText = data.transactions_count;
                document.getElementById('valDebt').innerText = data.total_debt + ' ₴';
                document.getElementById('finReportResult').style.display = 'block';
            } else {
                showError(await response.text());
            }
        } catch (e) {
            showError("System error");
        } finally {
            toggleLoading(false);
        }
    }

    // --- OCCUPANCY REPORT ---
    async function loadOccupancyReport() {
        const start = document.getElementById('occStart').value;
        const end = document.getElementById('occEnd').value;
        if(!start || !end) { alert("Select dates"); return; }

        toggleLoading(true);

        try {
            const response = await fetch(`/api/management/reports/occupancy?start=${start}&end=${end}`);
            if (response.ok) {
                const data = await response.json();

                document.getElementById('valTotalRooms').innerText = data.total_rooms;
                document.getElementById('valOccDays').innerText = data.occupied_days;
                document.getElementById('valAvailDays').innerText = data.available_days;

                const percent = data.occupancy_percentage;
                document.getElementById('valOccPercent').innerText = percent + '%';

                const bar = document.getElementById('occProgressBar');
                bar.style.width = percent + '%';

                if (percent > 80) bar.className = 'progress-bar bg-success';
                else if (percent > 50) bar.className = 'progress-bar bg-dark';
                else bar.className = 'progress-bar bg-warning text-dark';

                document.getElementById('occReportResult').style.display = 'block';
            } else {
                showError(await response.text());
            }
        } catch (e) {
            showError("System error");
        } finally {
            toggleLoading(false);
        }
    }

    // --- CUSTOMER FEEDBACK REPORT ---
    async function loadFeedbackReport() {
        const start = document.getElementById('feedStart').value;
        const end = document.getElementById('feedEnd').value;
        if(!start || !end) { alert("Select dates"); return; }

        toggleLoading(true);

        try {
            const response = await fetch(`/api/management/reports/customer-service?start=${start}&end=${end}`);
            if (response.ok) {
                const data = await response.json();

                document.getElementById('valReviewCount').innerText = data.reviews_count;
                document.getElementById('valAvgRating').innerText = data.avg_rating || '0.0';

                const rating = Math.round(data.avg_rating || 0);
                let starsHtml = '';
                for(let i=0; i<5; i++) {
                    if(i < rating) starsHtml += '★';
                    else starsHtml += '<span class="text-muted opacity-25">★</span>';
                }
                document.getElementById('valStars').innerHTML = starsHtml;

                const complaints = data.complaints_list;
                if (complaints && complaints !== 'Скарг немає') {
                    document.getElementById('valComplaints').innerText = complaints;
                } else {
                    document.getElementById('valComplaints').innerText = "No significant complaints recorded for this period.";
                }

                document.getElementById('feedReportResult').style.display = 'block';
            } else {
                showError(await response.text());
            }
        } catch (e) {
            showError("System error");
        } finally {
            toggleLoading(false);
        }
    }

    // --- ASSIGN CLEANING ---
    // --- ASSIGN CLEANING ---
    async function openCleaningModal() {
        document.getElementById('cleaningForm').reset();

        // Знаходимо селект
        const select = document.getElementById('cleanerSelect');
        select.innerHTML = '<option value="" disabled selected>Loading...</option>';

        // Відкриваємо модалку
        new bootstrap.Modal(document.getElementById('cleaningModal')).show();

        try {
            // Завантажуємо всіх працівників
            const response = await fetch('/api/management/staff');
            if (response.ok) {
                const employees = await response.json();

                select.innerHTML = '<option value="" disabled selected>Select Cleaner</option>';

                let count = 0;
                employees.forEach(emp => {
                    // ФІЛЬТР: Перевіряємо, чи містить посада слово "Cleaner" (або "cleaner")
                    if (emp.position && emp.position.toLowerCase().includes('cleaner')) {
                        select.innerHTML += `<option value="${emp.employee_id}">${emp.first_name} ${emp.last_name}</option>`;
                        count++;
                    }
                });

                // Якщо прибиральників не знайдено
                if (count === 0) {
                    select.innerHTML = '<option value="" disabled>No cleaners available</option>';
                }

            } else {
                select.innerHTML = '<option value="" disabled>Error loading staff</option>';
            }
        } catch (e) {
            console.error(e);
            select.innerHTML = '<option value="" disabled>System error</option>';
        }
    }

    async function submitCleaning() {
        const form = document.getElementById('cleaningForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const btn = document.querySelector('button[onclick="submitCleaning()"]');
        const originalText = btn.innerText;

        btn.disabled = true;
        btn.innerText = "Assigning...";

        try {
            const response = await fetch('/api/management/staff/assign-cleaning', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert("Cleaning task assigned successfully!");
                bootstrap.Modal.getInstance(document.getElementById('cleaningModal')).hide();
            } else {
                alert("Error: " + await response.text());
            }
        } catch (e) {
            console.error(e);
            alert("System error");
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    // --- ASSIGN SHIFT ---
    function openShiftModal(empId, empName) {
        document.getElementById('shiftEmpId').value = empId;
        document.getElementById('shiftEmpName').innerText = empName;
        document.getElementById('shiftForm').reset();
        new bootstrap.Modal(document.getElementById('shiftModal')).show();
    }

    async function submitShift() {
        const form = document.getElementById('shiftForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const empId = document.getElementById('shiftEmpId').value;
        const btn = document.querySelector('button[onclick="submitShift()"]');
        const originalText = btn.innerText;

        btn.disabled = true;
        btn.innerText = "Saving...";

        try {
            // URL: /api/management/staff/{id}/shift
            // Параметри передаються як query params або form-data. Fetch з body: formData автоматично відправляє їх.
            // Але @RequestParam в контролері очікує їх. FormData підходить.
            const response = await fetch(`/api/management/staff/${empId}/shift`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert("Shift assigned successfully!");
                bootstrap.Modal.getInstance(document.getElementById('shiftModal')).hide();
            } else {
                alert("Error: " + await response.text());
            }
        } catch (e) {
            console.error(e);
            alert("System error");
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    // --- NAVIGATION UPDATE ---
    function showSection(section) {
        // Ховаємо всі секції
        const sections = ['financial', 'occupancy', 'feedback', 'staff', 'workload'];
        sections.forEach(s => {
            const el = document.getElementById(s + 'Section');
            if(el) el.style.display = 'none';
        });

        // Показуємо потрібну
        const target = document.getElementById(section + 'Section');
        if(target) target.style.display = 'block';

        document.getElementById('commonError').style.display = 'none';
    }

    // --- WORKLOAD REPORT ---
    async function loadWorkloadReport() {
        const start = document.getElementById('workStart').value;
        const end = document.getElementById('workEnd').value;
        if(!start || !end) { alert("Select dates"); return; }

        toggleLoading(true);

        try {
            const response = await fetch(`/api/management/staff/workload?start=${start}&end=${end}`);
            if (response.ok) {
                const data = await response.json();
                const tbody = document.getElementById('workloadTableBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No data found for this period.</td></tr>';
                } else {
                    data.forEach(row => {
                        // Проста візуалізація "ефективності" на основі годин (для прикладу)
                        let badgeClass = 'bg-secondary';
                        if (row.total_hours > 160) badgeClass = 'bg-danger'; // Перепрацювання
                        else if (row.total_hours > 100) badgeClass = 'bg-success'; // Норма

                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-3 fw-bold text-dark">${row.full_name}</td>
                                <td><span class="badge bg-light text-dark border fw-normal x-small">${row.position}</span></td>
                                <td class="text-center">${row.shifts_count}</td>
                                <td class="text-center fw-bold">${row.total_hours} h</td>
                                <td class="pe-3 text-end">
                                    <span class="badge ${badgeClass} fw-normal x-small">Logged</span>
                                </td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('workloadResult').style.display = 'block';
            } else {
                showError(await response.text());
            }
        } catch (e) {
            showError("System error");
        } finally {
            toggleLoading(false);
        }
    }

    // --- VIEW SCHEDULE ---
    function openScheduleModal() {
        // Встановлюємо сьогоднішню дату за замовчуванням
        document.getElementById('scheduleDateInput').valueAsDate = new Date();
        // Очищаємо попередні результати
        document.getElementById('scheduleResultArea').innerHTML = '<div class="text-center text-secondary py-4 small">Click Load to view shifts.</div>';

        new bootstrap.Modal(document.getElementById('viewScheduleModal')).show();

        // Автоматично завантажуємо для зручності
        fetchSchedule();
    }

    async function fetchSchedule() {
        const date = document.getElementById('scheduleDateInput').value;
        const container = document.getElementById('scheduleResultArea');

        if (!date) { alert("Please select a date"); return; }

        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-secondary"></div></div>';

        try {
            const response = await fetch(`/api/management/staff/schedule?date=${date}`);

            if (response.ok) {
                const shifts = await response.json();

                if (shifts.length === 0) {
                    container.innerHTML = `<div class="alert alert-info border-0 text-center">No shifts assigned for ${date}.</div>`;
                    return;
                }

                let html = `
                    <table class="table table-hover align-middle border">
                        <thead class="table-light small text-uppercase">
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th class="text-center">Shift Start</th>
                                <th class="text-center">Shift End</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                shifts.forEach(s => {
                    // Проста логіка статусу (чи зараз йде зміна)
                    // Для точного відображення треба порівнювати з поточним часом, але тут просто покажемо час
                    html += `
                        <tr>
                            <td class="fw-bold text-dark">${s.full_name}</td>
                            <td><span class="badge bg-light text-secondary border fw-normal x-small">${s.position}</span></td>
                            <td class="text-center">${s.start_time}</td>
                            <td class="text-center">${s.end_time}</td>
                            <td class="text-center">
                                <span class="badge bg-success fw-normal x-small">Scheduled</span>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-danger">Error loading schedule.</div>';
            }
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="alert alert-danger">System error.</div>';
        }
    }

    // --- STAFF MANAGEMENT ---

    // 1. Load Staff List
    async function loadStaff() {
        showSection('staff');
        const container = document.getElementById('staffTableArea');
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';

        try {
            const response = await fetch('/api/management/staff');
            if (response.ok) {
                const employees = await response.json();

                if (employees.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No employees found.</div>';
                    return;
                }

                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light small text-uppercase text-secondary">
                                <tr>
                                    <th class="ps-3 py-3">ID</th>
                                    <th class="py-3">Name</th>
                                    <th class="py-3">Position</th>
                                    <th class="py-3">Phone</th>
                                    <th class="text-end pe-3 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                employees.forEach(emp => {
                    const fullName = `${emp.first_name} ${emp.last_name}`;
                    html += `
                        <tr>
                            <td class="ps-3 small text-secondary">#${emp.employee_id}</td>
                            <td class="fw-bold text-dark">${fullName}</td>
                            <td><span class="badge bg-light text-dark border fw-normal text-uppercase x-small">${emp.position}</span></td>
                            <td class="small text-muted">${emp.phone}</td>
                            <td class="text-end pe-3">
                                <button class="btn btn-sm btn-link text-primary p-0 me-2" title="Assign Shift"
                                        onclick="openShiftModal(${emp.employee_id}, '${fullName}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                </button>
                                <button class="btn btn-sm btn-outline-danger text-uppercase fw-bold x-small px-3"
                                        onclick="fireEmployee(${emp.employee_id}, '${fullName}')">
                                    Fire
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-danger">Error loading staff.</div>';
            }
        } catch (e) {
            container.innerHTML = '<div class="alert alert-danger">System error.</div>';
        }
    }

    // 2. Hire Employee
    function openHireModal() {
        document.getElementById('hireForm').reset();
        new bootstrap.Modal(document.getElementById('hireModal')).show();
    }

    async function submitHire() {
        const form = document.getElementById('hireForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const btn = document.querySelector('button[onclick="submitHire()"]');
        const originalText = btn.innerText;

        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            const response = await fetch('/api/management/staff', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Success! Employee hired. ID: ${data.employeeId}`);
                bootstrap.Modal.getInstance(document.getElementById('hireModal')).hide();
                loadStaff(); // Reload list
            } else {
                alert("Error: " + await response.text());
            }
        } catch (e) {
            console.error(e);
            alert("System error");
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    // 3. Fire Employee
    async function fireEmployee(id, name) {
        if (!confirm(`Are you sure you want to fire ${name}? This cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/management/staff/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert("Employee record removed.");
                loadStaff(); // Reload list
            } else {
                alert("Error: " + await response.text());
            }
        } catch (e) {
            console.error(e);
            alert("System error");
        }
    }

    // --- HELPERS ---
    function toggleLoading(show) {
        document.getElementById('commonLoading').style.display = show ? 'block' : 'none';
        document.getElementById('commonError').style.display = 'none';
    }

    function showError(msg) {
        const errDiv = document.getElementById('commonError');
        errDiv.innerText = "Error: " + msg;
        errDiv.style.display = 'block';
    }

</script>

<style>
    .x-small { font-size: 0.7rem; letter-spacing: 0.05em; }
    .hover-dark:hover { color: #111827 !important; background-color: #f3f4f6; }
</style>

</body>
</html>